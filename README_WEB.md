# 云效 K8s 自动部署 Web 服务

提供 Web 界面来触发云效到 K8s 的自动部署流程。

## 功能特性

- 🌐 **Web 界面控制** - 通过浏览器点击按钮触发部署
- 📡 **实时日志推送** - 使用 WebSocket 实时展示部署日志
- 🎨 **美观的界面** - 现代化的渐变设计,响应式布局
- 🔄 **状态管理** - 实时显示部署状态(空闲/执行中/成功/失败)
- 🖥️ **局域网访问** - 支持局域网内其他设备访问

## 快速开始

### 1. 安装依赖

```bash
# 安装 Web 服务依赖
pip install -r requirements-web.txt

# 如果还没安装原有依赖
pip install -r requirements.txt
```

### 2. 启动服务

```bash
python web_server.py
```

启动后会显示访问地址:
```
云效 K8s 自动部署 Web 服务
============================================================
本地访问: http://localhost:5000
局域网访问: http://<本机IP>:5000
============================================================
```

### 3. 访问界面

- **本机访问**: 浏览器打开 `http://localhost:5000`
- **局域网访问**:
  1. 查看本机 IP 地址(Mac: `ifconfig | grep inet`, Windows: `ipconfig`)
  2. 局域网内其他设备浏览器打开 `http://<本机IP>:5000`

### 4. 触发部署

点击页面中的 **"开始部署"** 按钮即可触发自动部署流程,实时查看日志输出。

## 界面预览

### 主界面
- 顶部紫色渐变 Header
- 状态卡片显示当前系统状态
- 大号部署按钮
- 底部黑色终端样式的日志区域

### 日志展示
- 时间戳
- 日志级别(INFO/SUCCESS/WARNING/ERROR)带颜色标识
- 日志内容
- 自动滚动到最新日志

### 状态指示
- **空闲** - 蓝色标签,系统就绪
- **执行中** - 橙色标签,带脉冲动画
- **成功** - 绿色标签,部署完成
- **失败** - 红色标签,显示错误信息

## 技术架构

- **后端框架**: Flask
- **实时通信**: Flask-SocketIO (WebSocket)
- **异步处理**: asyncio + threading
- **前端技术**: 原生 HTML/CSS/JavaScript + Socket.IO Client
- **样式设计**: 响应式布局,渐变色彩,动画效果

## API 接口

### GET /
- 返回主页面

### GET /api/status
- 获取当前任务状态
- 返回: `{ running, current_step, logs, result, start_time, end_time }`

### POST /api/deploy
- 触发部署任务
- 返回: `{ success, message }`

### WebSocket 事件
- `connect` - 连接建立
- `task_status` - 任务状态更新
- `log` - 日志推送

## 注意事项

1. **防火墙设置** - 确保 5000 端口未被防火墙阻止
2. **并发限制** - 同时只能运行一个部署任务
3. **浏览器兼容** - 推荐使用 Chrome/Firefox/Safari/Edge 现代浏览器
4. **首次运行** - 首次运行仍需手动登录云效和 K8s(会弹出浏览器窗口)
5. **登录状态** - 登录信息会保存在 `auth.json`,后续执行无需重复登录

## 自定义配置

### 修改端口
编辑 `web_server.py` 最后一行:
```python
socketio.run(app, host='0.0.0.0', port=5000)  # 修改 port 参数
```

### 修改主题颜色
编辑 `templates/index.html` 中的 CSS 变量:
```css
background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
```

## 故障排查

### 端口被占用
```bash
# Mac/Linux 查看占用进程
lsof -i :5000

# Windows 查看占用进程
netstat -ano | findstr :5000
```

### 无法访问
- 检查防火墙设置
- 确认本机 IP 地址正确
- 确保设备在同一局域网

### 日志不显示
- 检查浏览器控制台是否有 WebSocket 连接错误
- 尝试刷新页面重新连接

## 与原版本对比

| 特性 | 原版本(main.py) | Web 版本(web_server.py) |
|------|----------------|------------------------|
| 执行方式 | 命令行 | Web 界面 |
| 日志查看 | 终端输出 | 浏览器实时推送 |
| 远程控制 | 需 SSH | 浏览器访问 |
| 多人使用 | 需登录服务器 | 局域网直接访问 |
| 界面友好度 | ⭐⭐ | ⭐⭐⭐⭐⭐ |

## 许可证

与主项目相同
