# 云效到 K8s 镜像版本自动更新工具

## 📋 项目简介

这是一个基于 Playwright 的浏览器自动化工具,用于:

1. **触发云效构建** 并获取最新镜像版本号
2. **自动更新 K8s 控制台** 的 Deployment 镜像版本

全程通过浏览器操作,无需调用 API,符合"仅前端操作"的合规要求。

---

## ⚙️ 环境要求

- **操作系统**: macOS / Windows / Linux
- **Python 版本**: 3.8+
- **网络要求**:
  - 能访问云效公网地址
  - 能访问公司内网 K8s 控制台 (可能需要 VPN)

---

## 🚀 快速开始

### 1. 安装依赖

```bash
# 进入项目目录
cd yx2k8s

# 安装 Python 依赖
pip install -r requirements.txt

# 安装 Playwright 浏览器驱动
playwright install chromium
```

### 2. 首次运行

```bash
python main.py
```

**⚠️ 首次运行需要手动登录:**

1. 脚本会自动打开浏览器
2. 访问云效页面时,请手动登录
3. 访问 K8s 控制台时,请手动登录
4. 登录成功后,脚本会自动保存登录状态到 `auth.json`
5. 后续运行将自动复用登录状态,无需再次登录

### 3. 后续运行(全自动)

```bash
python main.py
```

后续运行会自动完成所有步骤,无需人工干预!

---

## 📂 项目结构

```
yx2k8s/
├── main.py              # 主程序入口
├── config.py            # 配置管理
├── yunxiao.py           # 云效操作模块
├── k8s.py               # K8s 操作模块
├── utils.py             # 工具函数(日志、截图)
├── requirements.txt     # Python 依赖
├── auth.json            # 登录状态存储(自动生成)
├── screenshots/         # 失败时的截图
├── logs/                # 日志目录(预留)
└── README.md            # 本文档
```

---

## 🔧 配置说明

所有配置都在 `config.py` 中,主要包括:

### 云效配置
```python
YUNXIAO_URL = "https://flow.aliyun.com/pipelines/4368447/current"
TAG_PATTERN = r'javaly/jpms-web:(dev-\d{4}-\d{2}-\d{2}-\d{2}-\d{2}-\d{2})'
```

### K8s 配置
```python
K8S_URL = "https://k8s.dev.wuxi.epartical.com:40022/..."
```

### 超时配置
```python
BUILD_TIMEOUT = 300000      # 构建超时 5 分钟
OPERATION_TIMEOUT = 30000   # 操作超时 30 秒
PAGE_LOAD_TIMEOUT = 60000   # 页面加载超时 1 分钟
```

### 浏览器配置
```python
HEADLESS = False  # 是否无头模式(True=后台运行, False=显示浏览器)
SCREENSHOT_ON_ERROR = True  # 失败时自动截图
```

---

## 🎯 工作流程

### 完整流程:

```
┌─────────────────────────────────────────┐
│  云效部分 (约 5-10 分钟)                 │
├─────────────────────────────────────────┤
│  1. 访问 Pipeline 页面                   │
│  2. 点击【运行】按钮                      │
│  3. 确认运行配置                         │
│  4. 等待构建完成                         │
│  5. 打开构建日志                         │
│  6. 提取版本号                           │
└─────────────────────────────────────────┘
                  ↓
┌─────────────────────────────────────────┐
│  K8s 部分 (约 10 秒)                     │
├─────────────────────────────────────────┤
│  1. 访问 Deployment 详情页               │
│  2. 点击【调整镜像版本】                  │
│  3. 填入新版本号                         │
│  4. 确认更新                             │
└─────────────────────────────────────────┘
```

---

## 📊 运行示例

```bash
$ python main.py

============================================================
云效到 K8s 镜像版本自动更新工具
============================================================
[2025-11-12 14:22:30] ℹ️ 启动浏览器 (无头模式: False)...
[2025-11-12 14:22:31] ℹ️ 检测到登录状态文件: auth.json

【步骤 1/2】云效: 触发构建并获取镜像版本号
------------------------------------------------------------
[2025-11-12 14:22:32] ▶️ 访问云效 Pipeline 页面...
[2025-11-12 14:22:35] ▶️ 点击【运行】按钮...
[2025-11-12 14:22:36] ▶️ 确认运行配置...
[2025-11-12 14:22:37] ⏳ 等待构建完成(最长5分钟)...
[2025-11-12 14:27:42] ✅ 构建已完成
[2025-11-12 14:27:43] ▶️ 打开构建日志...
[2025-11-12 14:27:45] ▶️ 展开镜像构建日志...
[2025-11-12 14:27:48] ✅ 成功获取版本号: dev-2025-11-12-14-20-32
------------------------------------------------------------
[2025-11-12 14:27:48] ✅ 【步骤 1/2】完成! 版本号: dev-2025-11-12-14-20-32

【步骤 2/2】K8s: 更新 Deployment 镜像版本
------------------------------------------------------------
[2025-11-12 14:27:49] ▶️ 访问 K8s Deployment 页面...
[2025-11-12 14:27:52] ▶️ 点击【调整镜像版本】按钮...
[2025-11-12 14:27:53] ℹ️ 调整镜像版本弹窗已打开
[2025-11-12 14:27:53] ▶️ 填入新版本号: dev-2025-11-12-14-20-32
[2025-11-12 14:27:54] ✅ 已填入新版本: dev-2025-11-12-14-20-32
[2025-11-12 14:27:54] ▶️ 点击【确定】按钮...
[2025-11-12 14:27:56] ✅ 镜像版本更新成功!
------------------------------------------------------------
[2025-11-12 14:27:56] ✅ 【步骤 2/2】完成!
[2025-11-12 14:27:56] ℹ️ 登录状态已保存到: auth.json

============================================================
[2025-11-12 14:27:56] ✅ 🎉 任务全部完成! 耗时: 5分26秒
============================================================
```

---

## ❓ 常见问题

### 1. 首次运行需要登录吗?

是的,首次运行需要手动登录云效和 K8s 控制台。登录后,脚本会自动保存登录状态到 `auth.json`,后续运行无需再次登录。

### 2. 如何切换账号?

删除 `auth.json` 文件,再次运行脚本即可手动登录新账号。

```bash
rm auth.json
python main.py
```

### 3. 构建超时怎么办?

默认构建超时时间是 5 分钟,如果构建时间较长,可以在 `config.py` 中调整:

```python
BUILD_TIMEOUT = 600000  # 改为 10 分钟
```

### 4. 失败时如何排查?

脚本失败时会自动截图保存到 `screenshots/` 目录,文件名包含时间戳和错误类型,例如:

```
screenshots/yunxiao_timeout_20251112_142530.png
screenshots/k8s_error_20251112_142530.png
```

### 5. 如何后台运行?

在 `config.py` 中设置:

```python
HEADLESS = True  # 开启无头模式
```

### 6. 支持多个 Deployment 吗?

当前版本仅支持单个 Deployment。如需支持多个,可以修改 `config.py` 添加配置列表,然后在 `main.py` 中循环调用。

### 7. 如何自定义 URL?

修改 `config.py` 中的 `YUNXIAO_URL` 和 `K8S_URL` 即可。

---

## 🔐 安全说明

- 全程本地执行,不上传任何数据
- 不保存账号密码,仅复用浏览器 Cookie
- 不调用云效 API 和 K8s API,仅模拟浏览器操作
- `auth.json` 文件包含登录凭证,请妥善保管

---

## 📝 维护与扩展

### 控制台页面改版怎么办?

如果云效或 K8s 控制台改版导致元素定位失败,只需要:

1. 更新 `yunxiao.py` 或 `k8s.py` 中的元素定位器
2. 无需改动整体流程逻辑

### 如何支持多环境?

在 `config.py` 中添加配置字典:

```python
ENVIRONMENTS = {
    'dev': {
        'yunxiao_url': '...',
        'k8s_url': '...',
    },
    'test': {
        'yunxiao_url': '...',
        'k8s_url': '...',
    },
}
```

然后在 `main.py` 中根据命令行参数选择环境。

---

## 📞 支持与反馈

如遇到问题或有改进建议,请联系开发团队。

---

## 📄 许可证

内部工具,仅供公司内部使用。

---

**祝使用愉快! 🎉**
