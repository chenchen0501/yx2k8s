# 测试指南

## 🧪 测试前准备

### 1. 安装依赖

```bash
cd /Users/chenchen/Documents/work/yx2k8s

# 安装 Python 依赖
pip3 install -r requirements.txt

# 安装 Playwright 浏览器
playwright install chromium
```

### 2. 检查配置

打开 [config.py](config.py) 确认以下配置:

- ✅ `YUNXIAO_URL`: 云效 Pipeline 地址
- ✅ `K8S_URL`: K8s Deployment 详情页地址
- ✅ `TAG_PATTERN`: 版本号提取正则表达式
- ✅ `HEADLESS = False`: 建议首次测试时使用可视化模式

---

## 🚀 开始测试

### 方式 1: 使用快捷脚本

```bash
./run.sh
```

### 方式 2: 直接运行

```bash
python3 main.py
```

---

## 📋 测试检查清单

### 步骤 1: 云效部分

- [ ] 浏览器成功打开云效页面
- [ ] 成功点击【运行】按钮
- [ ] 运行配置弹窗正常弹出
- [ ] 成功确认运行配置
- [ ] 构建开始运行
- [ ] 等待构建完成(约 5 分钟)
- [ ] 成功打开【日志】
- [ ] 成功点击"镜像构建并推送..."
- [ ] 日志弹窗正常显示
- [ ] 成功提取版本号(格式: `dev-YYYY-MM-DD-HH-MM-SS`)

### 步骤 2: K8s 部分

- [ ] 成功访问 K8s Deployment 页面
- [ ] 成功点击【调整镜像版本】按钮
- [ ] 弹窗正常打开
- [ ] 成功定位"新版本"输入框
- [ ] 成功填入新版本号
- [ ] 成功点击【确定】按钮
- [ ] 弹窗成功关闭
- [ ] 更新成功

### 步骤 3: 完整性检查

- [ ] `auth.json` 文件已生成
- [ ] 控制台输出完整且无错误
- [ ] 总耗时正常(约 5-10 分钟)

---

## 🐛 常见问题排查

### 1. 元素定位失败

**现象**: 报错 "Timeout waiting for selector"

**排查**:
1. 截图保存在 `screenshots/` 目录,查看页面状态
2. 检查页面结构是否改版
3. 打开浏览器开发者工具,确认元素选择器

**解决**:
- 更新 `yunxiao.py` 或 `k8s.py` 中的选择器

### 2. 登录态失效

**现象**: 页面跳转到登录页

**解决**:
```bash
# 删除 auth.json 重新登录
rm auth.json
python3 main.py
```

### 3. 构建超时

**现象**: "等待构建超时"

**解决**:
- 调整 `config.py` 中的 `BUILD_TIMEOUT`
- 或手动检查云效构建是否真的失败

### 4. 版本号提取失败

**现象**: "未找到版本号"

**排查**:
1. 查看 `screenshots/tag_not_found_*.png` 截图
2. 查看控制台输出的日志预览
3. 检查日志格式是否变化

**解决**:
- 更新 `config.py` 中的 `TAG_PATTERN` 正则表达式

---

## 🔍 调试技巧

### 1. 查看详细日志

脚本运行时会输出详细的步骤日志,包括:
- ℹ️ INFO: 一般信息
- ▶️ PROGRESS: 进度提示
- ⏳ WAITING: 等待中
- ✅ SUCCESS: 成功
- ❌ ERROR: 错误
- ⚠️ WARNING: 警告

### 2. 使用可视化模式

首次测试建议设置:
```python
# config.py
HEADLESS = False
```

这样可以看到浏览器实际操作过程,方便排查问题。

### 3. 查看截图

失败时会自动截图到 `screenshots/` 目录:
```bash
ls -lh screenshots/
```

### 4. 单步调试

可以在代码中添加断点:
```python
import pdb; pdb.set_trace()
```

或添加等待:
```python
await page.wait_for_timeout(5000)  # 等待 5 秒观察
```

---

## ✅ 测试成功标志

看到以下输出即表示成功:

```
============================================================
🎉 任务全部完成! 耗时: 5分26秒
============================================================
```

并且:
- K8s 控制台中 Deployment 的镜像版本已更新
- `auth.json` 文件已生成

---

## 📊 性能优化建议

### 首次运行后

1. **开启无头模式**:
   ```python
   # config.py
   HEADLESS = True
   ```
   后台运行更快,不占用屏幕

2. **调整超时时间**:
   根据实际情况调整超时配置,避免不必要的等待

3. **定时自动运行**:
   可以使用 cron (Linux/macOS) 或任务计划程序 (Windows) 定时运行

---

## 🎯 下一步优化方向

1. **支持多环境**: 添加命令行参数选择 dev/test/prod
2. **支持多 Deployment**: 批量更新多个服务
3. **通知机制**: 完成后发送钉钉/邮件通知
4. **失败重试**: 自动重试机制
5. **日志记录**: 保存完整运行日志到文件

---

有问题随时反馈! 🚀
