# 本地浏览器一键替换云效镜像版本号

## 端到端自动化方案设计说明书（无代码版）

---

### 一、背景与目标

1. 云效每次构建会生成形如 `2025-11-12-14-20-3` 的镜像版本号，仅出现在构建日志中。
2. 公司内网 K8s 控制台提供“调整镜像版本”按钮，需人工复制版本号 → 粘贴 → 点击确认。
3. 期望在**本地电脑**上“一键”完成：
   - 自动取得最新版本号
   - 自动打开 K8s 控制台并替换镜像
   - 全程不改动现有 CI/CD，不调用 K8s API，仅通过浏览器页面操作

---

### 二、核心思路概览

采用“浏览器自动化”路线，分三步：  
① **取号** ② **登台** ③ **替换**  
所有步骤通过**同一个本地浏览器实例**串行完成，利用页面 DOM 或 OCR 定位元素，完全不依赖 DOM 变更通知、不侵入云效或 K8s 后台。

---

### 三、阶段拆解与关键技术选型

| 阶段   | 目标                                                   | 关键技术点                                                                                                                       | 备选策略                                                                                          |
| ------ | ------------------------------------------------------ | -------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------- |
| ① 取号 | 拿到云效最新镜像 tag                                   | a. 直接访问构建详情 URL<br>b. 等待动态日志渲染完成<br>c. 用正则或 OCR 提取“pushing manifest for …:tag”行                         | • 若页面需登录：提前手动登录一次，后续复用 Cookie<br>• 若 tag 在折叠日志里：先模拟点击“展开”      |
| ② 登台 | 在内网控制台定位到指定 Deployment 的“调整镜像版本”入口 | a. 构造固定 URL（含集群、命名空间、Deployment 名）直接跳转<br>b. 等待页面加载完成                                                | • 若 URL 不固定：先全局搜索 Deployment 名，再点击进入详情页                                       |
| ③ 替换 | 把新版本号写进输入框并确认                             | a. 定位输入框（placeholder、label、class 等多属性组合）<br>b. 清空前值 → 填充新值 → 点击“确认/更新”按钮<br>c. 等待返回“成功”提示 | • 若输入框在弹窗/抽屉：先等待弹窗可见再操作<br>• 若按钮是 SVG/Canvas：转用截图+OCR 得到坐标后点击 |

---

### 四、异常与健壮性设计

1. **登录态失效**
   - 启动前检测 Cookie 是否有效，无效则中断并提示“请手动登录后重试”。
2. **网络抖动**
   - 每步操作后加“可见性+可点击”双重等待，超时 30 s 自动重试一次，再失败即报错退出。
3. **版本号格式变化**
   - 正则表达式预留“yyyy-mm-dd-hh-mm-ss”与“yyyy-mm-dd-hh-mm-n”两种模式，匹配失败立即截图留痕。
4. **K8s 控制台升级导致 DOM 变更**
   - 元素定位采用“文本+属性”双保险；升级后仅需更新定位器，无需改动流程。
5. **多人同时操作**
   - 脚本在本地运行，不调用集群 API，仅模拟单人点击，天然避免冲突。

---

### 五、安全与合规

- 全程本地执行，不保存账密，仅复用浏览器已有 Cookie。
- 不触碰云效 OpenAPI 与 K8s kube-apiserver，符合“仅前端操作”合规要求。
- 如企业要求零代码上传，可把脚本封装成离线可执行文件，源码可审计。

---

### 六、运行环境要求

- 操作系统：macOS / Windows / Linux 均可
- 浏览器：Chromium 内核（随自动化工具捆绑，无需改动现有浏览器）
- 网络：  
  – 能够打开云效公网地址  
  – 能够通过 VPN/公司网络访问内网 K8s 控制台
- 权限：本机需安装浏览器自动化驱动（工具首次运行会自动下载）

---

### 七、交付形式与使用方式

1. 一键脚本（双击或命令行 `python run.py`）。
2. 首次运行提示“请手动登录云效与 K8s 控制台”，登录后关闭浏览器窗口，脚本自动复用 Cookie。
3. 后续运行全程无人工干预，日志实时打印：
   - 取得版本号 → 打开控制台 → 替换成功/失败。
4. 失败时自动截图并输出时间戳，便于排查。

---

### 八、维护与扩展

| 场景                        | 扩展方式                                                 |
| --------------------------- | -------------------------------------------------------- |
| 新增环境（测试/预发）       | 在配置文件里加一条“环境-URL-Deployment”映射即可          |
| 控制台改版                  | 仅更新元素定位表达式，流程不变                           |
| 希望批量替换多个 Deployment | 把“登台+替换”封装为循环，读取 Excel/JSON 列表            |
| 后续想完全不用浏览器        | 可平滑过渡到调用云效 OpenAPI + K8s API，当前方案仅作过渡 |

---

### 九、总结

本方案以“本地浏览器自动化”为核心，通过“取号-登台-替换”三步完成云效到 K8s 的镜像版本同步。  
• 不读 DOM 也能用（OCR 兜底），但优先 DOM 更稳定；  
• 不侵入现有系统，零部署、零新增权限；  
• 脚本轻量、易维护，控制台一改版只需换定位器。

**达成目标：一条命令，版本号从云效“秒”进内网 K8s。**
